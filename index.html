<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>V2C</title>
<style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #e9eff1; }
    .chat-container { display: flex; flex-direction: column; height: 100vh; margin: auto; max-width: 600px; background-color: #fff; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); }
    .chat-header {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0;
    padding: 15px;
    background-color: #4CAF50;
    color: white;
}
    .chat-messages { flex-grow: 1; overflow: auto; padding: 20px; background: #f9f9f9; }

    .user-msg { background-color: #daf8cb; padding: 10px; border-radius: 10px; margin-bottom: 10px; max-width: 80%; align-self: flex-end; }
    .gpt-msg { background-color: #b0e5fc; padding: 10px; border-radius: 10px; margin-bottom: 10px; max-width: 80%; align-self: flex-start; }

    .chat-form {
        display: flex;
        padding: 10px;
        background-color: #f7f7f7;
    }

    .chat-form input {
        flex-grow: 1; /* input will fill up the remaining space */
        padding: 10px;
        margin-right: 10px;
        border: 1px solid #ccc;
        border-radius: 20px;
        margin-left: 10px; /* Adding left margin to align with other elements */
    }

    /* Adjustments on the button to keep its size */
    .chat-form button {
        width: calc(15% - 20px); /* Subtracting padding and margins from width */
        padding: 10px 15px;
        border: none;
        background-color: #4CAF50;
        color: white;
        border-radius: 20px;
        cursor: pointer;
    }

    .chat-form button:hover {
        background-color: #45a049;
    }

    /* Adjustments on the microphone button to make it circular */
    .mic-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px;
        width: 40px; /* Width and height should be the same for a circle */
        height: 40px;
        border: none;
        background-color: #4CAF50;
        color: white;
        border-radius: 50%; /* A large border-radius value will make it circular */
        cursor: pointer;
        margin-left: 10px; /* Adding left margin to align with other elements */
        box-sizing: border-box; /* Ensures that padding and borders are included in the width and height */
    }

    .mic-btn:hover {
        background-color: #45a049;
    }

    .mic-icon {
        font-size: 20px;
    }

    /* Styles for the menu icon in the header */
    .chat-header .menu-btn {
        margin-right: auto;
        font-size: 24px;
        cursor: pointer;
        margin-left: 10px;
        user-select: none; /* Prevents text selection on double click */
    }

    .title {
    flex-grow: 1;
    text-align: center;
}

    .spacer {
    display: inline-block;
    width: 48px; /* ä½¿å¾— spacer å’Œ .menu-btn æœ‰ç›¸åŒçš„å®½åº¦ */
    /* å¦‚æœ.menu-btnæ˜¯é€šè¿‡å†…è¾¹è·ç­‰å¾—åˆ°å®½åº¦ï¼Œå¯èƒ½éœ€è¦ç›¸åº”è°ƒæ•´æ­¤å€¼ */
}

#muteButton {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: white;
    margin-right: 5px;
}

</style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">
        <!-- æ³¨æ„ï¼Œæ­¤å¤„çš„ onclick é¡»åœ¨ç›¸åº”çš„ JS ä¸­å®šä¹‰å‡½æ•° toggleMenu -->
        <span class="menu-btn" onclick="toggleMenu()">&#9776;</span>
        <span class="title">V2C 1.0.3</span>
        <span class="spacer"></span>
        <button id="muteButton" onclick="toggleMute()">ğŸ”Š</button>
    </div>
    <div id="chat-messages" class="chat-messages">
        <!-- Chat messages will be displayed here -->
    </div>
    <!-- å£°çº¹æ•ˆæœå®¹å™¨ -->
    <canvas id="voicePrintCanvas" width="300" height="150" style="display:none;"></canvas>
    <div class="chat-form">
        <input type="text" id="message-input" placeholder="Type your message...">
        <button onclick="sendMessage()">Send</button>
        <!-- New microphone button -->
        <button class="mic-btn">
       <i class="mic-icon">&#127908;</i> <!-- Microphone icon -->
   </button>
    </div>
</div>

<script>
var eventSource = new EventSource("/stream");
var chatMessagesElement = document.getElementById("chat-messages");
var currentMessageParagraph = null; // ç”¨äºç´¯ç§¯å½“å‰æ¶ˆæ¯çš„æ®µè½
var audioQueue = []; // åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—æ¥ç®¡ç†è¦æ’­æ”¾çš„éŸ³é¢‘æ–‡ä»¶url
var isAudioPlaying = false; // ä¸€ä¸ªæ ‡å¿—ä½æ¥è®°å½•æ˜¯å¦æœ‰éŸ³é¢‘æ­£åœ¨æ’­æ”¾
var playedAudioFiles = new Set(); // ä¸€ä¸ªé›†åˆæ¥å­˜å‚¨å·²æ’­æ”¾è¿‡çš„éŸ³é¢‘æ–‡ä»¶url

var holdTimer;
var isRecording = false; // ç”¨æ¥è®°å½•æ˜¯å¦æ­£åœ¨å½•éŸ³

var audioContext;
var analyserNode;
var microphoneStream;
var javascriptNode;
var canvas, canvasContext;

var mediaRecorder;
var audioChunks = [];

var isMuted = false;

function toggleMute() {
    isMuted = !isMuted;
    document.getElementById("muteButton").textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";

    // é™éŸ³æˆ–å–æ¶ˆé™éŸ³æ‰€æœ‰éŸ³é¢‘å…ƒç´ 
    var audioElements = document.querySelectorAll('audio');
    audioElements.forEach(function(audio) {
        audio.muted = isMuted;
    });
}

// æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶
eventSource.onmessage = function(event) {
    var data = JSON.parse(event.data);
    var messageText = data.message;

    if (!currentMessageParagraph) {
        currentMessageParagraph = document.createElement("p");
        currentMessageParagraph.classList.add('gpt-msg');
        chatMessagesElement.appendChild(currentMessageParagraph);
    }

    currentMessageParagraph.textContent += messageText;
    chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight;

    if (data.audio_filename && !playedAudioFiles.has(data.audio_filename)) {
        playedAudioFiles.add(data.audio_filename); // å°†æ–‡ä»¶æ ‡è®°ä¸ºå·²æ’­æ”¾
        audioQueue.push("/audio/" + data.audio_filename); // æ³¨æ„è¿™é‡Œçš„è·¯å¾„

        if (!isAudioPlaying) {
            playNextAudio();  // å¦‚æœæ²¡æœ‰éŸ³é¢‘æ­£åœ¨æ’­æ”¾ï¼Œç«‹å³æ’­æ”¾ä¸‹ä¸€ä¸ªéŸ³é¢‘
        }
    }
};

function playNextAudio() {
    if (audioQueue.length > 0 && !isAudioPlaying) {
        var audioUrl = audioQueue.shift(); // è·å–å¹¶ç§»é™¤é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶url
        var audio = new Audio(audioUrl);
        audio.muted = isMuted; // æ ¹æ®é™éŸ³çŠ¶æ€è®¾ç½®
        isAudioPlaying = true; // æ ‡è®°éŸ³é¢‘æ­£åœ¨æ’­æ”¾
        audio.play();
        audio.onended = function() {
            isAudioPlaying = false; // æ›´æ–°æ ‡å¿—ä½
            playNextAudio(); // å°è¯•æ’­æ”¾ä¸‹ä¸€ä¸ªéŸ³é¢‘
        };
    }
}

function resetCurrentMessage() {
    currentMessageParagraph = null;
}

function sendMessage() {
    var inputElement = document.getElementById("message-input");
    var message = inputElement.value;
    inputElement.value = "";

    var userMessageDiv = document.createElement("div");
    userMessageDiv.textContent = "User: " + message;
    userMessageDiv.className = "user-msg";
    chatMessagesElement.appendChild(userMessageDiv);

    resetCurrentMessage();
    chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight;

    fetch("/send_message", {
        method: "POST",
        body: new URLSearchParams("message=" + encodeURIComponent(message)),
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
        },
    });
}

// Handle sending the message with Enter key (but not when Shift is pressed)
document.getElementById("message-input").addEventListener("keypress", function(event) {
    if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
});
// Additional JavaScript function for menu button toggle
    function toggleMenu() {
        // Code to show/hide the menu goes here
        alert("Menu button clicked!"); // Placeholder action, replace with actual menu behavior
    }


document.addEventListener("DOMContentLoaded", function () {
    // åˆå§‹åŒ–å£°éŸ³æ‰“å°å’Œå…¶ä»–é¡µé¢å…ƒç´ 
    initializeVoicePrint();

    // é‡ç½®æœåŠ¡å™¨ç«¯ä¼šè¯
    fetch("/reset_session", {
    method: "POST"
})
.then(response => response.json())
.then(data => {
    if (data.success && data.action === "reset_session") {
        console.log("Session reset successfully.");
        // ä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–éœ€è¦åœ¨ä¼šè¯é‡ç½®åæ‰§è¡Œçš„ä»£ç 
    } else {
        console.error("Failed to reset session.");
    }
})
.catch(error => console.error('Error:', error));


    // è®¾ç½®å½•éŸ³æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
    var micButton = document.querySelector('.mic-btn');
    micButton.addEventListener('mousedown', startRecording);
    micButton.addEventListener('mouseup', stopRecording);
    micButton.addEventListener('mouseleave', stopRecording); // å¦‚æœé¼ æ ‡ç¦»å¼€æŒ‰é’®ä¹Ÿåœæ­¢å½•éŸ³
    micButton.addEventListener('touchstart', startRecording); // ä¸ºè§¦æ‘¸å±æ·»åŠ äº‹ä»¶
    micButton.addEventListener('touchend', stopRecording);
});


function initializeVoicePrint() {
    if (audioContext) return; // å¦‚æœaudioContextå·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›
    // è·å–Canvaså…ƒç´ åŠå…¶ä¸Šä¸‹æ–‡
    canvas = document.getElementById('voicePrintCanvas');
    canvasContext = canvas.getContext('2d');
    // åˆå§‹åŒ–Web Audio
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyserNode = audioContext.createAnalyser();
    analyserNode.fftSize = 512;
    javascriptNode = audioContext.createScriptProcessor(512, 1, 1);

    // è¿æ¥ScriptProcessorçš„èŠ‚ç‚¹ï¼Œç”¨äºç»˜åˆ¶å£°æ³¢
    javascriptNode.connect(audioContext.destination);
    analyserNode.connect(javascriptNode);

    // å½“ScriptProcessorçš„èŠ‚ç‚¹æœ‰éŸ³é¢‘æ•°æ®é‡‡æ ·æ—¶ï¼Œå°†è°ƒç”¨æ­¤å‡½æ•°ç»˜å›¾
    javascriptNode.onaudioprocess = function() {
        // è·å–é¢‘åŸŸæ•°æ®
        var dataArray = new Uint8Array(analyserNode.frequencyBinCount);
        analyserNode.getByteFrequencyData(dataArray);

        canvasContext.clearRect(0, 0, canvas.width, canvas.height);
        drawFrequency(dataArray);
    };

    // è¯·æ±‚éº¦å…‹é£è®¿é—®æƒé™
    navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
        microphoneStream = stream;
        var source = audioContext.createMediaStreamSource(stream);
    source.connect(analyserNode);
}).catch(function(error) {
    console.error('Access to microphone denied', error);
});
}



function startRecording(event) {
    event.preventDefault();
    audioChunks = []; // é‡ç½®å½•éŸ³æ•°æ®æ•°ç»„

    holdTimer = setTimeout(function() {
        isRecording = true;
        showVoicePrint();

        if (microphoneStream) {
            mediaRecorder = new MediaRecorder(microphoneStream, { mimeType: 'audio/webm' });

            mediaRecorder.ondataavailable = function(event) {
                audioChunks.push(event.data);
            };

            mediaRecorder.start();
        } else {
            console.error("Microphone stream is not available.");
        }
    }, 500); // é•¿æŒ‰500mså¼€å§‹å½•éŸ³
}


function stopRecording(event) {
    event.preventDefault();
    clearTimeout(holdTimer);

    if (isRecording) {
        isRecording = false;
        hideVoicePrint();

        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
            mediaRecorder.onstop = function() {
                var audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                var audioFile = new File([audioBlob], "record.webm", { type: 'audio/webm' });
                var formData = new FormData();
                formData.append("audio", audioFile);

                fetch("/send_audio", {
    method: "POST",
    body: formData
})
.then(response => response.json())
.then(data => {
    if (data.success) {
        // è°ƒç”¨æ˜¾ç¤ºæ¶ˆæ¯çš„å‡½æ•°å¤„ç†è¿”å›çš„transcript
        handleTranscript(data.transcript);
    } else {
        // é”™è¯¯å¤„ç†
        console.error('Error:', data.error);
    }
})
.catch(error => console.error('Error:', error));

// å¤„ç†å¹¶æ˜¾ç¤ºtranscript
function handleTranscript(transcript) {
    var userMessageDiv = document.createElement("div");
    userMessageDiv.textContent = "User: " + transcript;
    userMessageDiv.className = "user-msg";
    chatMessagesElement.appendChild(userMessageDiv);
    chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight;
    resetCurrentMessage(); // é‡ç½®å½“å‰æ¶ˆæ¯æ®µè½
}

                // é‡ç½®audioChunksä¸ºä¸‹ä¸€æ¬¡å½•éŸ³åšå‡†å¤‡
                audioChunks = [];

                // ææ„mediaRecorderå¯¹è±¡
                mediaRecorder = null;
            };
        }
    }
}


function showVoicePrint() {
    if (!audioContext) {
        initializeVoicePrint();
    }
    canvas.style.display = 'block';
}

function hideVoicePrint() {
    if (microphoneStream) {
        microphoneStream.getTracks().forEach(track => track.stop());
        microphoneStream = null;
    }
    if (javascriptNode) {
        javascriptNode.disconnect();
        javascriptNode = null;
    }
    if (analyserNode) {
        analyserNode.disconnect();
    }
    if (audioContext) {
        audioContext.close().then(() => {
            audioContext = null; // åœ¨å…³é—­åå°†audioContextç½®ä¸ºnull
            initializeVoicePrint(); // é‡æ–°åˆå§‹åŒ–VoicePrint
        });
    }
    canvas.style.display = 'none';
}

function drawFrequency(dataArray) {
    var width = canvas.width;
    var height = canvas.height;
    var barWidth = (width / dataArray.length) * 2.5;
    var barHeight;
    var x = 0;

    for (var i = 0; i < dataArray.length; i++) {
        barHeight = dataArray[i]/2;
        canvasContext.fillStyle = 'rgb(' + (barHeight+100) + ',50,50)';
        canvasContext.fillRect(x,height-barHeight/2,barWidth,barHeight/2);
        x += barWidth + 1;
    }
}
</script>
</body>
</html>